# Copilot Instructions: Arbitrary Microstructure Flow Prediction

## Project Overview

This is a **physics-informed ML project** for predicting resin flow fields (velocity and pressure) in fibrous composite microstructures using U-Net models with a sliding window technique. Not a diffusion model despite the repo name—it's computational fluid dynamics surrogate modeling.

**Key Architecture**: Two separate U-Net predictors (`VelocityPredictor` and `PressurePredictor`) trained independently, used together via `SlidingWindow` for arbitrary-sized domains.

## Critical Components

### Dual Predictor System
- **VelocityPredictor** (`src/predictor.py`): Predicts 2-channel (vx, vy) flow velocity from binary microstructure images
  - Input: 1-channel binary image (1=fluid, 0=fiber), optionally distance-transformed
  - Output: 2-channel normalized velocity field
- **PressurePredictor** (`src/predictor.py`): Predicts pressure field with physical length awareness
  - Input: 2 channels (microstructure + normalized inverse length `1/x_length`)
  - Output: 1-channel ρ-normalized pressure field
  - **Critical preprocessing**: multiplies first channel by fiber volume fraction, inverts second channel (see `pre_process`)

### Physics-Based Post-Processing
- **Velocity correction** (`src/apps.py:correct_velocity_field`): Enforces constant inlet flow rate across domain width
- **Pressure shifting** (`src/apps.py:shift_pressure_fields`): Aligns overlapping window predictions using average pressure at boundaries
- These corrections are ESSENTIAL—predictions without them (`prediction_naive`) have significantly worse physics consistency

### Sliding Window Implementation
- Fragments large rectangular microstructures into 256×256 overlapping squares
- `define_window_positions()`: Creates windows with `step_size` spacing (typically 2px) horizontally, full height divisions vertically
- `average_frames()`: Overlays predictions using weighted averaging (tracking overlap counts)
- Handles edge cases: adjusts final window position to cover uncovered domain edges

## Data Flow & Normalization

1. **Input normalization** (`src/normalizer.py:MaxNormalizer`):
   - Velocity model: no input normalization (distance transform only)
   - Pressure model: normalizes by `(1, max_length)` from `statistics.json`
2. **Output normalization**: All predictions normalized by max values during training
   - Velocity: `(max_vx, max_vy)` 
   - Pressure: `(max_p,)`
3. **Denormalization**: `.predict()` methods call `.inverse()` automatically

**Key file**: `statistics.json` in dataset root—auto-generated by `MicroFlowDataset._save_statistics()`, required for proper normalization.

## Training & Evaluation Workflows

### Training from Scratch
```bash
# Velocity model
python train.py --root-dir data/dataset --predictor-type velocity --in-channels 1 --out-channels 2

# Pressure model  
python train.py --root-dir data/dataset --predictor-type pressure --in-channels 2 --out-channels 1 --distance-transform ''
```
- Dataset auto-downloads from Zenodo if `--root-dir` empty
- Saves to timestamped folder: `trained/{date}_{name}_{predictor-type}_{hyperparams}/`
- Outputs: `model.pt`, `best_model.pt`, `log.json` (contains full config + training history)

### Model Loading Patterns
Three equivalent methods (see `src/predictor.py:Predictor`):
```python
# From local directory
predictor = Predictor.from_directory(folder, device)

# From Zenodo URL (auto-downloads & caches to `pretrained/`)
predictor = Predictor.from_url(url, device)

# Auto-detects local vs URL
predictor = Predictor.from_directory_or_url(directory_or_url, device)
```

### Evaluation
```bash
# Standard validation
python eval.py --root-dir data/dataset --split valid \
  --directory-or-url https://zenodo.org/records/17306446/files/velocity_model_base.zip?download=1

# Micrograph benchmark (uses sliding window)
python -m scripts.eval_micrograph --micrograph-dir path/to/micrographs \
  --velocity-model {url_or_path} --pressure-model {url_or_path}
```

## Project-Specific Conventions

### Tensor Shape Conventions
- **Microstructures**: `(batch, 1, height, width)` - binary with 1=fluid, 0=fiber
- **Velocity fields**: `(batch, 2, height, width)` - channels are [vx, vy]
- **Pressure fields**: `(batch, 1, height, width)` - scalar field
- **Physical dimensions**: `(batch, 3)` - [dx, dy, dz] in meters

### Configuration via `config.py`
- Uses `argparse` groups (dataset, training, optimization) processed into nested dicts
- **Attention mechanism**: String format `"start.end.heads"` (e.g., `"3..2"` = levels 3-max with 2 heads)
  - Empty string `""` = no attention
  - Parsed by `src/unet/models.py:eval_expression()`
- **Distance transform**: Bool flag that applies `scipy.ndimage.distance_transform_edt` to inputs

### Loss Functions (`src/unet/metrics.py`)
- Primary: `normalized_mae_loss` - MAE divided by mean absolute target (scale-invariant)
- Alternative: `mae_loss` - standard MAE
- **Not used in training** but available: `mass_conservation_loss` for physics constraints

## External Dependencies

- **Dataset**: Auto-downloaded from [Zenodo 16940478](https://doi.org/10.5281/zenodo.16940478) (square microstructures)
- **Pre-trained models**: [Zenodo 17306446](https://doi.org/10.5281/zenodo.17306446)
- **Micrograph benchmark**: [Zenodo 6611926](https://doi.org/10.5281/zenodo.6611926) - requires manual access request
- **Zenodo utilities** (`utils/zenodo.py`): Handles downloads, unzipping, URL detection

## Development Notes

### When Modifying Models
- **Never change normalization** without retraining—breaks pre-trained weights
- **UNet features list**: Must be power-of-2 progression for encoder/decoder symmetry
- **Attention levels**: 1-indexed in config string, converted to 0-indexed internally

### When Adding New Predictors
- Inherit from `Predictor` (abstract base in `src/predictor.py`)
- Implement: `forward()`, `predict()`, `pre_process()`, `type` property
- Override `init_normalizer()` if custom normalization needed
- Update `src/helper.py:set_model()` and `get_model()` with new type

### Dataset Handling
- `MicroFlowDataset` (`utils/dataset.py`): Handles both x-flow and y-flow simulations
  - Y-flow data rotated 90° and velocity channels swapped
- Data augmentation: Vertical flips with sign correction for vy component
- **3D dataset variant**: `MicroFlowDataset3D` uses single permeability value across slices

### Windows-Specific
- Tested on Ubuntu 22.04 LTS (development environment)
- PowerShell requires `;` for command chaining, not `&&`
- Use forward slashes or raw strings for paths in code

## Physics Context

**Darcy's Law**: `K = (Q * μ * L) / (A * ΔP)` where K=permeability, Q=flow rate, μ=viscosity (0.5 default), L=length, A=cross-section area, ΔP=pressure drop

**Flow rate calculation** (`src/physics.py:get_flow_rate`): Section-wise averaging of velocity × fluid area, not simple integration
